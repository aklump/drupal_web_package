<?php
/**
 * @file
 * Base module file for package
 *
 * @defgroup package Package
 * @{
 */

use Drupal\Core\Url;

/**
 * Implements hook_toolbar_alter().
 *
 * Add the version to the Toolbar.
 */
function web_package_toolbar_alter(&$items) {
  $highest_weight = 0;
  foreach ($items as $item) {
    $weight = isset($item['#weight']) ? $item['#weight'] : 0;
    $highest_weight = max($highest_weight, $weight);
  }
  $items['web_package'] = [
    // Custom CSS, JS or a library can be associated with the toolbar item.
    '#attached' => [
      'library' => [
        'web_package/core',
      ],
    ],
    '#type' => 'toolbar_item',
    '#weight' => $highest_weight + 1,
    '#wrapper_attributes' => [
      'class' => ['web-package-toolbar-tab'],
    ],
    'tab' => [
      '#type' => 'link',
      '#title' => \Drupal::service('web_package')->getVersion(),
      '#url' => Url::fromRoute('system.status'),
    ],
  ];
}

/**
 * Implements hook_loft_deploy_title_pre_alter().
 *
 * Add the version to the title.
 */
function web_package_loft_deploy_title_pre_alter(&$title) {
  try {
    if (($info = \Drupal::service('web_package')->getInfo())
      && isset($info['version'])) {
      $title .= t(' ~ @version', ['@version' => $info['version']]);
    }
  }
  catch (\Exception $exception) {
    watchdog_exception('web_package', $exception);
  }
}

/**
 * Implements hook_preprocess_status_report_general_info().
 */
function web_package_preprocess_status_report_general_info(&$vars) {
  $info = \Drupal::service('web_package')->getInfo();
  if ($info['name'] && $info['version']) {
    $vars['drupal']['description'] = t('<strong>:name :version</strong><br/>:description', [
      ':name' => $info['name'],
      ':version' => $info['version'],
      ':description' => $info['description'],
    ]);
  }
}
